# Ruby のベースイメージを指定
FROM ruby:3.3.6

# 環境変数の設定
ENV LANG C.UTF-8  # 日本語対応
ENV TZ Asia/Tokyo # タイムゾーンを日本に設定

# 必要なパッケージのインストール
RUN apt-get update -qq && apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    build-essential \
    libpq-dev \
    vim

# Node.js 20.xのインストール
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
RUN apt-get install -y nodejs

# Yarnのインストール
RUN npm install -g yarn

# アプリケーションディレクトリの作成
RUN mkdir /myapp
WORKDIR /myapp

# Bundlerのインストール
RUN gem install bundler

# Gemfileのコピーとbundle install（キャッシュ効率化）
COPY Gemfile* ./
RUN bundle install

# package.jsonのコピーとyarn install（キャッシュ効率化）
COPY package*.json yarn.lock* ./
RUN yarn install || true

# アプリケーションのコードをコピー
COPY . /myapp

# ポート公開
EXPOSE 3000

# 起動コマンド
CMD ["bash", "-c", "bundle install && bin/dev"]