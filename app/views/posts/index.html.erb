<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>ã‚ãªãŸã®æ—¥è¨˜è¨˜éŒ²</h2>
    <%= link_to 'æ–°ã—ã„æ—¥è¨˜ã‚’æ›¸ã', new_post_path, class: 'btn btn-primary' %>
  </div>

  <% if @posts.any? %>
    <% @posts.each_with_index do |post, index| %>
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title"><%= post.title %></h5>
          <p class="card-text"><%= truncate(post.body, length: 100) %></p>
          <small class="text-muted"><%= post.created_at.strftime("%Yå¹´%mæœˆ%dæ—¥ %H:%M") %></small>
          <%= link_to "è©³ç´°ã‚’è¦‹ã‚‹", post_path(post), class: "btn btn-outline-primary btn-sm" %>

        <!-- æ“¬ä¼¼ã„ã„ã­æ©Ÿèƒ½ -->
          <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="likes-counter" data-target="<%= post.auto_likes_count %>" data-index="<%= index %>">
              <span class="heart-icon">â¤ï¸ã„ã„ã­</span>
              <span class="count">0</span>
              <!-- â˜… ãƒãƒ¼ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚³ãƒ³ãƒ†ãƒŠè¿½åŠ  â˜… -->
              <div class="hearts-container"></div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="text-center py-5">
      <p class="text-muted">ã¾ã æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      <%= link_to 'æœ€åˆã®æ—¥è¨˜ã‚’æ›¸ã', new_post_path, class: 'btn btn-primary' %>
    </div>
  <% end %>
</div>

<%= content_for :javascript do %>
<script>
document.addEventListener('turbo:load', function() {
  document.querySelectorAll('.likes-counter:not(.animated)').forEach(function(element, index) {
    const counter = element.querySelector('.count');
    const heartsContainer = element.querySelector('.hearts-container');
    const target = parseInt(element.dataset.target);
    
    if (!counter || !target || target <= 0) return;
    
    element.classList.add('animated');
    
    setTimeout(() => {
      // æ•°å­—ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      let current = 0;
      const increment = Math.ceil(target / 50);
      
      const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
          counter.textContent = target.toLocaleString();
          clearInterval(timer);
        } else {
          counter.textContent = current.toLocaleString();
        }
      }, 30);
      
      // â˜… ãƒãƒ¼ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¿®æ­£ç‰ˆï¼‰ â˜…
      if (heartsContainer) {
        animateExplodingHearts(heartsContainer, target);
      }
    }, index * 200);
  });
});

// â˜… çˆ†ç™ºãƒãƒ¼ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ï¼ˆä¿®æ­£ç‰ˆï¼‰ â˜…
function animateExplodingHearts(container, targetCount) {
  const heartCount = Math.min(Math.floor(targetCount / 100), 8); // 100ã„ã„ã­ã”ã¨ã«1ãƒãƒ¼ãƒˆã€æœ€å¤§8å€‹
  
  if (heartCount <= 0) return;
  
  // ã‚³ãƒ³ãƒ†ãƒŠã‚’ç›¸å¯¾é…ç½®ã«è¨­å®š
  container.style.position = 'relative';
  container.style.display = 'inline-block';
  container.style.width = '1px';
  container.style.height = '1px';
  
  // ä¸€æ°—ã«ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
  for (let i = 0; i < heartCount; i++) {
    setTimeout(() => {
      createExplodingHeart(container, i, heartCount);
    }, i * 150); // 150msé–“éš”ã§ãƒãƒ¼ãƒˆç”Ÿæˆ
  }
}

function createExplodingHeart(container, index, totalHearts) {
  const heart = document.createElement('span');
  const heartTypes = ['ğŸ’–', 'ğŸ’•', 'ğŸ’—', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ'];
  heart.textContent = heartTypes[index % heartTypes.length];
  heart.className = 'exploding-heart';
  
  // å††å½¢ã«é…ç½®ï¼ˆ8æ–¹å‘ã«åˆ†æ•£ï¼‰
  const angle = (Math.PI * 2 * index) / totalHearts;
  const distance = Math.random() * 60 + 30; // 30-90pxã®è·é›¢
  const endX = Math.cos(angle) * distance;
  const endY = Math.sin(angle) * distance;
  
  heart.style.position = 'absolute';
  heart.style.left = '0px';
  heart.style.top = '0px';
  heart.style.transform = 'translate(-50%, -50%) scale(0)';
  heart.style.transition = 'all 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
  heart.style.pointerEvents = 'none';
  heart.style.zIndex = '1000';
  heart.style.fontSize = (Math.random() * 8 + 16) + 'px'; // ãƒ©ãƒ³ãƒ€ãƒ ã‚µã‚¤ã‚º
  
  container.appendChild(heart);
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
  setTimeout(() => {
    heart.style.transform = `translate(calc(-50% + ${endX}px), calc(-50% + ${endY}px)) scale(1)`;
    heart.style.opacity = '0';
  }, 100);
  
  // æ¸…æƒ
  setTimeout(() => {
    if (heart.parentNode) {
      heart.remove();
    }
  }, 1300);
}
</script>
<% end %>